<!DOCTYPE html>
<html>
<head>
    <title>Wacky Willy 26SS Dashboard</title>
    <meta charset="utf-8">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <link href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/fixedcolumns/4.0.2/css/fixedColumns.bootstrap5.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    
    <!-- Reliable CDN for SheetJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" onerror="alert('Error loading XLSX library. Check internet connection.');"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js/dist/chart.umd.min.js"></script>
    
    <style>
        body { background-color: #f8f9fa; padding: 20px; font-family: 'Segoe UI', sans-serif; font-size: 0.85rem; }
        .card { margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border: none; }
        .card-header { background-color: #fff; border-bottom: 2px solid #333; font-weight: bold; font-size: 1rem; }
        .kpi-box { text-align: center; padding: 15px; background: white; border-radius: 8px; }
        .kpi-val { font-size: 24px; font-weight: bold; color: #2c3e50; }
        .kpi-label { font-size: 12px; color: #7f8c8d; text-transform: uppercase; }
        .col-md-1-5 { flex: 0 0 16.666667%; max-width: 16.666667%; padding-left: 12px; padding-right: 12px; }
        
        th { white-space: nowrap; text-align: center; vertical-align: middle; font-size: 0.8rem; padding: 8px 4px; }
        td { white-space: nowrap; text-align: right; vertical-align: middle; font-size: 0.85rem; padding: 6px 4px; }
        td:nth-child(1), td:nth-child(2), td:nth-child(3), td:nth-child(4), td:nth-child(5), td:nth-child(6) { text-align: center; }
        
        .pos-growth { color: green; font-weight: bold; }
        .neg-growth { color: red; font-weight: bold; }
        .insight-box { background-color: #e8f4f8; border-left: 4px solid #17a2b8; padding: 10px; margin-bottom: 15px; font-size: 0.9rem; color: #0c5460; }
        .insight-title { font-weight: bold; display: block; margin-bottom: 5px; }
        
        /* Select2 Customization */
        .select2-container { width: 100% !important; }
        .select2-selection--multiple { 
            min-height: 38px; 
            padding: 2px; 
            font-size: 0.8rem;
            max-height: 150px; 
            overflow-y: auto; 
        }
        .select2-selection__choice { margin-top: 4px !important; }
        .select2-search__field { margin-top: 6px !important; }
        
        /* Dropdown Scroll Fix */
        .select2-results__options { 
            max-height: 400px !important;
            overflow-y: auto !important; 
        }
        
        tfoot th { background-color: #e9ecef; font-weight: bold; border-top: 2px solid #6c757d; text-align: right; font-size: 0.8rem; }
        .progress { height: 25px; margin-bottom: 20px; font-weight: bold; font-size: 0.8rem; }
        .chart-container { position: relative; height: 180px; width: 100%; }
        .chart-container-lg { position: relative; height: 300px; width: 100%; }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div class="d-flex align-items-center">
                <h2 class="me-3 mb-0">ğŸš€ Wacky Willy 26SS Dashboard</h2>
                <div class="d-inline-flex align-items-center me-2">
                    <input type="file" id="excelInput" accept=".xlsx, .xls" style="display: none;" />
                    <button type="button" class="btn btn-primary btn-sm me-2" onclick="document.getElementById('excelInput').click()">
                        ğŸ“ Upload Excel
                    </button>
                    <span id="upload-status" class="small text-muted">Ready</span>
                </div>
                <span id="data-source-badge" class="badge bg-warning text-dark">Sample Data</span>
                <span id="lib-status" class="badge bg-secondary ms-2 small">Checking...</span>
            </div>
            <span class="text-muted">Updated: {report_date}</span>
        </div>

        <div class="row mb-3">
            <div class="col-md-3"><div class="kpi-box"><div class="kpi-val" id="kpi-total-sales">-</div><div class="kpi-label">Total Sales (KRW)</div></div></div>
            <div class="col-md-3"><div class="kpi-box"><div class="kpi-val" id="kpi-total-qty">-</div><div class="kpi-label">Total Qty Sold</div></div></div>
            <div class="col-md-3"><div class="kpi-box"><div class="kpi-val" id="kpi-sell-through">-</div><div class="kpi-label">Sell-Through Rate</div></div></div>
            <div class="col-md-3"><div class="kpi-box"><div class="kpi-val" id="kpi-current-stock">-</div><div class="kpi-label">Current Stock</div></div></div>
        </div>

        <!-- Filter Section -->
        <div class="card mb-4 border-primary">
            <div class="card-header bg-primary text-white">
                <i class="bi bi-funnel"></i> ğŸ” Global Search Filters (ë°ì´í„° í•„í„°)
            </div>
            <div class="card-body bg-light">
                <div class="row g-3">
                    <div class="col-md-1-5">
                        <label class="form-label fw-bold">êµ¬ë¶„ (ê¸ˆë…„/ì „ë…„)</label>
                        <select class="form-select filter-input" id="filter-gubun" multiple></select>
                    </div>
                    <div class="col-md-1-5">
                        <label class="form-label fw-bold">ì—°ë„ (Year)</label>
                        <select class="form-select filter-input" id="filter-year" multiple></select>
                    </div>
                    <div class="col-md-1-5">
                        <label class="form-label fw-bold">ì‹œì¦Œ (Season)</label>
                        <select class="form-select filter-input" id="filter-season" multiple></select>
                    </div>
                    <div class="col-md-1-5">
                        <label class="form-label fw-bold">ì„±ë³„ (Gender)</label>
                        <select class="form-select filter-input" id="filter-gender" multiple></select>
                    </div>
                    <div class="col-md-1-5">
                        <label class="form-label fw-bold">êµ¬ë¶„ (Type)</label>
                        <select class="form-select filter-input" id="filter-type" multiple></select>
                    </div>
                    <div class="col-md-1-5">
                        <label class="form-label fw-bold">ëŒ€ë³µì¢… (Cat-L)</label>
                        <select class="form-select filter-input" id="filter-cat-l" multiple></select>
                    </div>
                    <div class="col-md-1-5">
                        <label class="form-label fw-bold">ë³µì¢… (Cat-M)</label>
                        <select class="form-select filter-input" id="filter-cat-m" multiple></select>
                    </div>
                </div>
                <div class="d-flex justify-content-end mt-3">
                    <button class="btn btn-secondary btn-sm" id="btn-reset-filters">ğŸ”„ í•„í„° ì´ˆê¸°í™” (Reset)</button>
                </div>
            </div>
        </div>

        <!-- Visual Analysis Section -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header fw-bold">ğŸ“Š Customer & Product Segmentation (ê³ ê°/ìƒí’ˆêµ° ë¶„ì„)</div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <h6 class="text-center small text-muted mb-2">Gender Share (ì„±ë³„)</h6>
                                <div class="chart-container">
                                    <canvas id="chart-gender"></canvas>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-center small text-muted mb-2">Type Share (êµ¬ë¶„)</h6>
                                <div class="chart-container">
                                    <canvas id="chart-type"></canvas>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-center small text-muted mb-2">Pareto (ìƒìœ„ 20% ìƒí’ˆ ë§¤ì¶œë¹„ì¤‘)</h6>
                                <div class="chart-container">
                                    <canvas id="chart-pareto"></canvas>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-center small text-muted mb-2">Season Share (ì‹œì¦Œ)</h6>
                                <div class="chart-container">
                                    <canvas id="chart-season"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header fw-bold">ğŸ“ˆ Category Performance (ì¹´í…Œê³ ë¦¬ë³„ ì„±ê³¼)</div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-center small text-muted mb-2">Large Category (ëŒ€ë³µì¢…)</h6>
                                <div class="chart-container" style="height:200px">
                                    <canvas id="chart-category-l"></canvas>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-center small text-muted mb-2">Sub Category (ë³µì¢… - Top 5)</h6>
                                <div class="chart-container" style="height:200px">
                                    <canvas id="chart-category-m"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12">
                                <h6 class="text-center small text-muted mb-2">ğŸ† Top 10 Best Sellers Share (ë² ìŠ¤íŠ¸ 10 ì§‘ì¤‘ë„)</h6>
                                <div class="chart-container" style="height:250px">
                                    <canvas id="chart-top10"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Advanced Insight Section -->
        <div class="card mb-4 border-info">
            <div class="card-header bg-info text-dark bg-opacity-10 fw-bold">
                <i class="bi bi-lightbulb"></i> ğŸ¤– AI Strategic Insights (ì „ëµ ì œì–¸)
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="alert alert-success mb-0 h-100">
                            <h6 class="alert-heading fw-bold"><i class="bi bi-graph-up-arrow"></i> Growth Opportunities</h6>
                            <div id="insight-growth" class="small">Analyzing...</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="alert alert-warning mb-0 h-100">
                            <h6 class="alert-heading fw-bold"><i class="bi bi-exclamation-triangle"></i> Inventory Risk</h6>
                            <div id="insight-risk" class="small">Analyzing...</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="alert alert-primary mb-0 h-100">
                            <h6 class="alert-heading fw-bold"><i class="bi bi-check2-square"></i> Action Plan</h6>
                            <div id="insight-action" class="small">Analyzing...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mb-4">
            <div class="card-header">ğŸ­ Production & Sales Status (ìƒì‚°íŒë§¤í˜„í™©íŒ - ì „ë…„ë¹„êµ)</div>
            <div class="card-body">
                <div class="insight-box" id="catInsight">
                    <span class="insight-title">ğŸ’¡ Category Insight</span>
                    <span id="catInsightText">Loading...</span>
                </div>
                <div class="table-responsive">
                    <table id="catTable" class="table table-hover table-striped table-bordered" style="width:100%">
                        <thead class="table-light">
                            <tr>
                                <th>ì—°ë„</th><th>ì‹œì¦Œ</th><th>ì„±ë³„</th><th>êµ¬ë¶„</th><th>ëŒ€ë³µì¢…</th><th>ë³µì¢…</th><th>ë°œì£¼(ìˆ˜ëŸ‰)</th><th>ë°œì£¼(ë°±ë§Œ)</th><th>ì…ê³ (ìˆ˜ëŸ‰)</th><th>ì…ê³ (ë°±ë§Œ)</th><th>ì…ê³ ìœ¨(%)</th><th>ì£¼ê°„(ìˆ˜ëŸ‰)</th><th>ì£¼ê°„(ë°±ë§Œ)</th><th>ì „ë…„ì£¼ê°„(ìˆ˜ëŸ‰)</th><th>ì „ë…„ì£¼ê°„(ë°±ë§Œ)</th><th>ì£¼ê°„ì‹ ì¥(%)</th><th>ì£¼ê°„ëˆ„ì (ìˆ˜ëŸ‰)</th><th>ì£¼ê°„ëˆ„ì (ë°±ë§Œ)</th><th>ì „ë…„ëˆ„ì (ìˆ˜ëŸ‰)</th><th>ì „ë…„ëˆ„ì (ë°±ë§Œ)</th><th>ëˆ„ì ì‹ ì¥(%)</th><th>ì¬ê³ (ìˆ˜ëŸ‰)</th><th>ì¬ê³ (ë°±ë§Œ)</th><th>ì†Œì§„ìœ¨(%)</th>
                            </tr>
                        </thead>
                        <tbody id="catBody">
                            <!-- JS populated aggregated data -->
                        </tbody>
                        <tfoot>
                            <tr>
                                <th colspan="6" style="text-align:center">Total</th>
                                <th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">ğŸ† Top 10 Heroes (íŒë§¤ ë² ìŠ¤íŠ¸ - ë™ì  í•„í„°ë§)</div>
                    <div class="card-body">
                        <div class="insight-box" id="topInsight">
                            <span class="insight-title">ğŸ’¡ Best Sellers Insight</span>
                            <span id="topInsightText">Loading...</span>
                        </div>
                        <div class="table-responsive">
                            <table id="topTable" class="table table-sm table-hover table-striped table-bordered">
                                <thead class="table-light">
                                    <tr><th>ìŠ¤íƒ€ì¼</th><th>ì»¬ëŸ¬</th><th>êµ¬ë¶„</th><th>ë³µì¢…</th><th>ë°œì£¼(ìˆ˜ëŸ‰)</th><th>ë°œì£¼(ë°±ë§Œ)</th><th>ì…ê³ (ìˆ˜ëŸ‰)</th><th>ì…ê³ (ë°±ë§Œ)</th><th>ì…ê³ ìœ¨(%)</th><th>ì£¼ê°„(ìˆ˜ëŸ‰)</th><th>ì£¼ê°„(ë°±ë§Œ)</th><th>ëˆ„ì (ìˆ˜ëŸ‰)</th><th>ëˆ„ì (ë°±ë§Œ)</th><th>ì¬ê³ (ìˆ˜ëŸ‰)</th><th>ì¬ê³ (ë°±ë§Œ)</th><th>ì†Œì§„ìœ¨(%)</th></tr>
                                </thead>
                                <tbody id="topBody">
                                    <!-- JS populated -->
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <th colspan="4" class="text-center">Total (Top 10)</th>
                                        <th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-12">
                <div class="card">
                    <div class="card-header">âš ï¸ Inventory Risk (íŒë§¤ìˆìŒ & ì¬ê³ ê³¼ë‹¤ & ì €íš¨ìœ¨ - ë™ì  í•„í„°ë§)</div>
                    <div class="card-body">
                        <div class="insight-box" id="riskInsight">
                            <span class="insight-title">ğŸ’¡ Risk Inventory Insight</span>
                            <span id="riskInsightText">Loading...</span>
                        </div>
                        <div class="table-responsive">
                            <table id="riskTable" class="table table-sm table-hover table-striped table-bordered">
                                <thead class="table-light">
                                    <tr><th>ìŠ¤íƒ€ì¼</th><th>ì»¬ëŸ¬</th><th>êµ¬ë¶„</th><th>ë³µì¢…</th><th>ë°œì£¼(ìˆ˜ëŸ‰)</th><th>ë°œì£¼(ë°±ë§Œ)</th><th>ì…ê³ (ìˆ˜ëŸ‰)</th><th>ì…ê³ (ë°±ë§Œ)</th><th>ì…ê³ ìœ¨(%)</th><th>ì£¼ê°„(ìˆ˜ëŸ‰)</th><th>ì£¼ê°„(ë°±ë§Œ)</th><th>ëˆ„ì (ìˆ˜ëŸ‰)</th><th>ëˆ„ì (ë°±ë§Œ)</th><th>ì¬ê³ (ìˆ˜ëŸ‰)</th><th>ì¬ê³ (ë°±ë§Œ)</th><th>ì†Œì§„ìœ¨(%)</th></tr>
                                </thead>
                                <tbody id="riskBody">
                                    <!-- JS populated -->
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <th colspan="4" class="text-center">Total (Risk 10)</th>
                                        <th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/fixedcolumns/4.0.2/js/dataTables.fixedColumns.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    
    <script>
        // Global raw data initialized by Python
        window.itemData = {item_data_json}; // Placeholder
        window.isSampleData = false;
        window.charts = { gender: null, type: null, categoryL: null, categoryM: null, top10: null, pareto: null, season: null };
        
        // --- Standalone Upload Logic (No jQuery dependency) ---
        window.addEventListener('load', function() {
            console.log('Window loaded. Initializing Upload Handler...');
            
            var fileInput = document.getElementById('excelInput');
            if (!fileInput) {
                console.error('CRITICAL: File input #excelInput not found!');
                return;
            }

            fileInput.addEventListener('change', function(e) {
                var file = e.target.files[0];
                if (!file) return;

                var statusEl = document.getElementById('lib-status');
                if(statusEl) {
                    statusEl.innerText = 'Reading...';
                    statusEl.className = 'badge bg-warning text-dark ms-2 small';
                }

                if (!file.name.match(/\.(xlsx|xls)$/i)) {
                    alert('âš ï¸ Please select an Excel file (.xlsx or .xls)');
                    return;
                }

                var reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        if (typeof XLSX === 'undefined') {
                            throw new Error('XLSX library not loaded. Please check internet connection.');
                        }

                        console.log('Parsing Excel...');
                        var data = new Uint8Array(e.target.result);
                        var workbook = XLSX.read(data, {type: 'array', cellDates: true});
                        var mergedData = [];

                        console.log('Sheets found:', workbook.SheetNames);

                        // Read ALL sheets (No skipping logic initially to ensure data load)
                        workbook.SheetNames.forEach(function(sheetName) {
                            var json = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
                            console.log('Sheet:', sheetName, 'Rows:', json.length);
                            
                            json.forEach(function(item) {
                                var cleanItem = {};
                                Object.keys(item).forEach(function(k) { cleanItem[k.trim()] = item[k]; });

                                // Inference Logic
                                var gubun = cleanItem['êµ¬ë¶„'];
                                var year = parseInt(cleanItem['ê¸°íšì •ë³´_ì—°ë„']);

                                if (!gubun) {
                                    if (sheetName.includes('ì „ë…„')) gubun = 'ì „ë…„';
                                    else if (sheetName.includes('ê¸ˆë…„')) gubun = 'ê¸ˆë…„';
                                    else if (year === 25) gubun = 'ì „ë…„';
                                    else if (year === 26) gubun = 'ê¸ˆë…„';
                                    else gubun = 'ê¸ˆë…„'; // Default
                                }
                                cleanItem['êµ¬ë¶„'] = gubun;
                                
                                // Auto-calc metrics
                                var qtyIn = parseFloat(cleanItem['ëˆ„ê³„ì…ê³ _ìˆ˜ëŸ‰'] || 0);
                                var qtyOrder = parseFloat(cleanItem['ë°œì£¼_ìˆ˜ëŸ‰'] || 0);
                                var qtySold = parseFloat(cleanItem['ëˆ„ê³„íŒë§¤_ìˆ˜ëŸ‰'] || 0);
                                
                                if (cleanItem['In_Rate'] == null) cleanItem['In_Rate'] = qtyOrder > 0 ? (qtyIn/qtyOrder*100) : 0;
                                if (cleanItem['Sell_Through'] == null) cleanItem['Sell_Through'] = qtyIn > 0 ? (qtySold/qtyIn*100) : 0;

                                mergedData.push(cleanItem);
                            });
                        });

                        if (mergedData.length === 0) {
                            alert('âš ï¸ No valid data rows found.');
                            if(statusEl) statusEl.innerText = 'Empty';
                            return;
                        }

                        // Deduplicate
                        var uniqueMap = new Map();
                        mergedData.forEach(function(item) {
                            var uid = (item.ì‹œìŠ¤í…œì •ë³´_í’ˆë²ˆ||'') + (item.ì‹œìŠ¤í…œì •ë³´_ìƒ‰ìƒ||'') + (item.ê¸°íšì •ë³´_ì—°ë„||'') + (item.ê¸°íšì •ë³´_ì‹œì¦Œ||'');
                            if(!uniqueMap.has(uid)) uniqueMap.set(uid, item);
                        });

                        var finalData = Array.from(uniqueMap.values());
                        console.log('Upload Success. Rows:', finalData.length);

                        // Update Global Data
                        window.itemData = finalData;
                        window.isSampleData = false;

                        // Trigger Dashboard Refresh
                        if (typeof initDashboard === 'function') {
                            initDashboard();
                            alert('âœ… Data Loaded: ' + finalData.length + ' rows');
                            if(statusEl) {
                                statusEl.innerText = 'Loaded';
                                statusEl.className = 'badge bg-success text-white ms-2 small';
                            }
                        } else {
                            console.error('initDashboard function missing');
                        }

                    } catch (ex) {
                        console.error('Upload Error:', ex);
                        alert('âŒ Error: ' + ex.message);
                        if(statusEl) statusEl.innerText = 'Error';
                    }
                };
                reader.readAsArrayBuffer(file);
            });
        });

        $(document).ready(function() {
            // Library Check
            if (typeof XLSX === 'undefined') {
                $('#lib-status').text('Lib Missing').addClass('bg-danger');
            } else {
                $('#lib-status').text('Ready').addClass('bg-success').fadeOut(3000);
            }

            // Initial Load
            if (window.itemData && window.itemData.length > 0) {
                initDashboard();
            } else {
                initFilterOptions([]);
            }
            
            // "All" Button Injection
            $('.card-body .row .col-md-1-5').each(function() {
                var $col = $(this);
                var $label = $col.find('label.form-label');
                var $select = $col.find('select');

                if ($label.length > 0 && $select.length > 0) {
                    if($label.find('.btn-select-all').length === 0) {
                        var $btn = $('<button type="button" class="btn btn-outline-secondary btn-sm py-0 px-1 ms-2 btn-select-all" style="font-size:0.7rem">All</button>');
                        $btn.on('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            var allVals = $select.find('option').map(function() { return $(this).val(); }).get();
                            $select.val(allVals).trigger('change');
                        });
                        $label.append($btn);
                    }
                }
            });

            // Filter change listener
            $('.filter-input').on('change', function() {
                refreshAll();
            });

            // Reset button
            $('#btn-reset-filters').on('click', function() {
                $('.filter-input').each(function() {
                    var $this = $(this);
                    if ($this.hasClass('select2-hidden-accessible')) {
                        $this.val(null).trigger('change');
                    } else {
                        $this.val(null).trigger('change');
                    }
                });
                refreshAll();
            });
            
            // NOTE: Previous Upload Logic removed in favor of standalone handler above script block
        });
            
            function initDashboard() {
                updateDataSourceStatus();
                initFilterOptions(window.itemData);
                refreshAll();
            }
            
            function updateDataSourceStatus() {
                var $badge = $('#data-source-badge');
                if(window.isSampleData) {
                    $badge.text('âš ï¸ Sample Data').removeClass('bg-success text-white').addClass('bg-warning text-dark');
                } else {
                    $badge.text('âœ… Uploaded Data (' + window.itemData.length + ' rows)').removeClass('bg-warning text-dark').addClass('bg-success text-white');
                }
            }

            function initFilterOptions(data) {
                populateSelect('filter-gubun', data, 'êµ¬ë¶„');
                populateSelect('filter-year', data, 'ê¸°íšì •ë³´_ì—°ë„');
                populateSelect('filter-season', data, 'ê¸°íšì •ë³´_ì‹œì¦Œ');
                populateSelect('filter-gender', data, 'ê¸°íšì •ë³´_ì„±ë³„');
                populateSelect('filter-type', data, 'ê¸°íšì •ë³´_ì˜ë¥˜/ìš©í’ˆ');
                populateSelect('filter-cat-l', data, 'ê¸°íšì •ë³´_ëŒ€ë³µì¢…');
                populateSelect('filter-cat-m', data, 'ê¸°íšì •ë³´_ë³µì¢…');
            }


            function populateSelect(id, data, key) {
                var $el = $('#' + id);
                if ($el.hasClass("select2-hidden-accessible")) $el.select2('destroy');
                var unique = [...new Set(data.map(item => item[key]))].sort();
                $el.empty();
                unique.forEach(val => {
                    if(val !== undefined && val !== null) $el.append(new Option(val, val));
                });
                initSelect2($el);
            }
            
            function initSelect2($target) {
                $target.select2({
                    placeholder: "Select... (Empty = All)",
                    allowClear: true,
                    width: '100%',
                    closeOnSelect: false
                });
            }

            function getActiveFilters() {
                return {
                    'êµ¬ë¶„': $('#filter-gubun').val(),
                    'ê¸°íšì •ë³´_ì—°ë„': $('#filter-year').val(),
                    'ê¸°íšì •ë³´_ì‹œì¦Œ': $('#filter-season').val(),
                    'ê¸°íšì •ë³´_ì„±ë³„': $('#filter-gender').val(),
                    'ê¸°íšì •ë³´_ì˜ë¥˜/ìš©í’ˆ': $('#filter-type').val(),
                    'ê¸°íšì •ë³´_ëŒ€ë³µì¢…': $('#filter-cat-l').val(),
                    'ê¸°íšì •ë³´_ë³µì¢…': $('#filter-cat-m').val()
                };
            }

            function refreshAll() {
                updateDataSourceStatus();
                var filters = getActiveFilters();
                var filteredData = itemData.filter(function(item) {
                    for (var key in filters) {
                        var fVals = filters[key];
                        if (fVals && fVals.length > 0) {
                            if(!fVals.includes(String(item[key]))) return false;
                        }
                    }
                    return true;
                });

                updateKPIs(filteredData);
                updateCharts(filteredData);
                generateAdvancedInsights(filteredData, filters);
                renderCategoryTable(filteredData, itemData);
                updateItemTables(filteredData);
            }
            
            function safeNum(val) {
                if (val === undefined || val === null || val === '') return 0;
                var num = parseFloat(val);
                return isNaN(num) ? 0 : num;
            }

            function updateKPIs(data) {
                var totalSales = data.reduce((a, b) => a + safeNum(b.ëˆ„ê³„íŒë§¤_ê¸ˆì•¡), 0);
                var totalQty = data.reduce((a, b) => a + safeNum(b.ëˆ„ê³„íŒë§¤_ìˆ˜ëŸ‰), 0);
                var totalStock = data.reduce((a, b) => a + safeNum(b.ì´ì¬ê³ _ìˆ˜ëŸ‰), 0);
                var totalIn = data.reduce((a, b) => a + safeNum(b.ëˆ„ê³„ì…ê³ _ìˆ˜ëŸ‰), 0);
                var sellThrough = totalIn > 0 ? (totalQty / totalIn * 100).toFixed(1) + '%' : '0.0%';
                
                $('#kpi-total-sales').text((totalSales / 1000000).toLocaleString(undefined, {maximumFractionDigits:0}));
                $('#kpi-total-qty').text(totalQty.toLocaleString());
                $('#kpi-sell-through').text(sellThrough);
                $('#kpi-current-stock').text(totalStock.toLocaleString());
            }

            // --- Chart Functions ---
            function updateCharts(data) {
                updateDoughnutChart('gender', 'chart-gender', aggregateData(data, 'ê¸°íšì •ë³´_ì„±ë³„'), 'Gender Share');
                updateDoughnutChart('type', 'chart-type', aggregateData(data, 'ê¸°íšì •ë³´_ì˜ë¥˜/ìš©í’ˆ'), 'Type Share');
                updateDoughnutChart('season', 'chart-season', aggregateData(data, 'ê¸°íšì •ë³´_ì‹œì¦Œ'), 'Season Share');
                
                // Pareto Chart
                var validItems = data.filter(x => safeNum(x.ëˆ„ê³„íŒë§¤_ê¸ˆì•¡) > 0);
                var sortedItems = [...validItems].sort((a,b) => safeNum(b.ëˆ„ê³„íŒë§¤_ê¸ˆì•¡) - safeNum(a.ëˆ„ê³„íŒë§¤_ê¸ˆì•¡));
                var top20Count = Math.max(1, Math.ceil(sortedItems.length * 0.2));
                var topSales = sortedItems.slice(0, top20Count).reduce((a,b) => a + safeNum(b.ëˆ„ê³„íŒë§¤_ê¸ˆì•¡), 0);
                var totalSales = sortedItems.reduce((a,b) => a + safeNum(b.ëˆ„ê³„íŒë§¤_ê¸ˆì•¡), 0);
                
                updateDoughnutChart('pareto', 'chart-pareto', [
                    { label: 'Top 20% Items', value: topSales },
                    { label: 'Bottom 80%', value: totalSales - topSales }
                ], 'Pareto Share');
                
                updateBarChart('categoryL', 'chart-category-l', aggregateData(data, 'ê¸°íšì •ë³´_ëŒ€ë³µì¢…'), 'Large Category');
                
                var subCatData = aggregateData(data, 'ê¸°íšì •ë³´_ë³µì¢…');
                if(subCatData.length > 5) subCatData = subCatData.slice(0, 5);
                updateBarChart('categoryM', 'chart-category-m', subCatData, 'Sub Category (Top 5)');
                
                // Top 10 Share
                var top10Items = [...data].sort((a,b) => safeNum(b.ëˆ„ê³„íŒë§¤_ê¸ˆì•¡) - safeNum(a.ëˆ„ê³„íŒë§¤_ê¸ˆì•¡)).slice(0, 10);
                var top10Data = top10Items.map(item => {
                    var amt = safeNum(item.ëˆ„ê³„íŒë§¤_ê¸ˆì•¡);
                    var share = totalSales > 0 ? (amt / totalSales * 100).toFixed(1) : 0;
                    return { label: item.ì‹œìŠ¤í…œì •ë³´_í’ˆë²ˆ, value: share, rawValue: amt };
                });
                var top10Sum = top10Data.reduce((a, b) => a + parseFloat(b.value), 0);
                updateBarChart('top10', 'chart-top10', top10Data, 'Top 10 Share: ' + top10Sum.toFixed(1) + '%', true);
            }
            
            function aggregateData(data, key) {
                var map = {};
                data.forEach(item => {
                    var k = item[key] || 'Unknown';
                    map[k] = (map[k] || 0) + safeNum(item.ëˆ„ê³„íŒë§¤_ê¸ˆì•¡);
                });
                return Object.entries(map).sort((a,b) => b[1] - a[1]).map(e => ({ label: e[0], value: e[1] }));
            }

            function updateDoughnutChart(key, id, data, title) {
                var ctx = document.getElementById(id).getContext('2d');
                if (charts[key]) charts[key].destroy();
                if (data.length === 0) return; 

                charts[key] = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: data.map(d => d.label),
                        datasets: [{ data: data.map(d => d.value), backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', '#858796'] }]
                    },
                    options: { maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 10 } } }, layout: { padding: 0 } }
                });
            }

            function updateBarChart(key, id, data, title, isPercent = false) {
                var ctx = document.getElementById(id).getContext('2d');
                if (charts[key]) charts[key].destroy();
                if (data.length === 0) return;

                charts[key] = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.map(d => d.label),
                        datasets: [{ label: isPercent ? 'Share (%)' : 'Sales', data: data.map(d => d.value), backgroundColor: '#4e73df' }]
                    },
                    options: {
                        maintainAspectRatio: false, indexAxis: 'y',
                        plugins: { legend: { display: false }, title: { display: true, text: title },
                            tooltip: { callbacks: { label: function(c) { return isPercent ? c.raw + '%' : 'â‚©' + (c.raw/1000000).toLocaleString() + 'M'; } } }
                        },
                        scales: { x: { ticks: { callback: function(v) { return isPercent ? v + '%' : 'â‚©' + (v/1000000).toLocaleString() + 'M'; } } } }
                    }
                });
            }
            
            // --- Advanced Insights ---
            function generateAdvancedInsights(data, filters) {
                var weekSalesQty = data.reduce((a, b) => a + safeNum(b.ê¸°ê°„íŒë§¤_ìˆ˜ëŸ‰), 0);
                var totalStockQty = data.reduce((a, b) => a + safeNum(b.ì´ì¬ê³ _ìˆ˜ëŸ‰), 0);
                var wos = weekSalesQty > 0 ? (totalStockQty / weekSalesQty).toFixed(1) : 999;
                
                var momentumHtml = "<ul class='mb-0 ps-3'>";
                if (weekSalesQty === 0) momentumHtml += "<li>ğŸ’¤ <strong>Dormant:</strong> No sales this week.</li>";
                else if (wos < 4) momentumHtml += "<li>ğŸ”¥ <strong>Hot:</strong> Low WOS (" + wos + " weeks). Restock needed.</li>";
                else momentumHtml += "<li>âš–ï¸ <strong>Stable:</strong> WOS is " + wos + " weeks.</li>";
                momentumHtml += "</ul>";
                $('#insight-growth').html(momentumHtml);
                
                var riskHtml = "<ul class='mb-0 ps-3'>";
                var heavyStock = data.filter(x => safeNum(x.ì´ì¬ê³ _ìˆ˜ëŸ‰) > 500 && (safeNum(x.ëˆ„ê³„íŒë§¤_ìˆ˜ëŸ‰)/(safeNum(x.ëˆ„ê³„ì…ê³ _ìˆ˜ëŸ‰)||1)*100) < 10).length;
                if(heavyStock > 0) riskHtml += "<li>ğŸ“‰ <strong>Overstock:</strong> " + heavyStock + " styles with high stock & low sales.</li>";
                else riskHtml += "<li>âœ¨ <strong>Clean:</strong> No major overstock issues.</li>";
                riskHtml += "</ul>";
                $('#insight-risk').html(riskHtml);
                
                var actionHtml = "<ul class='mb-0 ps-3'><li>ğŸ” Monitor daily sales trends.</li></ul>";
                $('#insight-action').html(actionHtml);
            }

            // --- Tables ---
            function renderCategoryTable(data, fullData) {
                if ($.fn.DataTable.isDataTable('#catTable')) $('#catTable').DataTable().destroy();
                
                // 1. Build Reference Map from "ì „ë…„" DATA (for YoY)
                var refMap = {};
                if(fullData) {
                    fullData.forEach(item => {
                        var gubun = String(item.êµ¬ë¶„ || '').trim();
                        if (gubun !== 'ì „ë…„') return; // Only include "ì „ë…„" data

                        // Normalize keys: trim and uppercase
                        var season = String(item.ê¸°íšì •ë³´_ì‹œì¦Œ || '').trim();
                        var gender = String(item.ê¸°íšì •ë³´_ì„±ë³„ || '').trim();
                        var type = String(item['ê¸°íšì •ë³´_ì˜ë¥˜/ìš©í’ˆ'] || '').trim();
                        var catL = String(item.ê¸°íšì •ë³´_ëŒ€ë³µì¢… || '').trim();
                        var catM = String(item.ê¸°íšì •ë³´_ë³µì¢… || '').trim();

                        // Key excludes Year
                        var key = [season, gender, type, catL, catM].join('|');

                        if(!refMap[key]) refMap[key] = { weekQty:0, weekAmt:0, cumQty:0, cumAmt:0 };
                        refMap[key].weekQty += safeNum(item.ê¸°ê°„íŒë§¤_ìˆ˜ëŸ‰);
                        refMap[key].weekAmt += safeNum(item.ê¸°ê°„íŒë§¤_ê¸ˆì•¡);
                        refMap[key].cumQty += safeNum(item.ëˆ„ê³„íŒë§¤_ìˆ˜ëŸ‰);
                        refMap[key].cumAmt += safeNum(item.ëˆ„ê³„íŒë§¤_ê¸ˆì•¡);
                    });
                }
                
                // 2. Aggregate Current Filtered Data
                var groups = {};
                data.forEach(item => {
                    var year = String(item.ê¸°íšì •ë³´_ì—°ë„ || '').trim();
                    var season = String(item.ê¸°íšì •ë³´_ì‹œì¦Œ || '').trim();
                    var gender = String(item.ê¸°íšì •ë³´_ì„±ë³„ || '').trim();
                    var type = String(item['ê¸°íšì •ë³´_ì˜ë¥˜/ìš©í’ˆ'] || '').trim();
                    var catL = String(item.ê¸°íšì •ë³´_ëŒ€ë³µì¢… || '').trim();
                    var catM = String(item.ê¸°íšì •ë³´_ë³µì¢… || '').trim();

                    var key = [year, season, gender, type, catL, catM].join('|');
                    
                    if(!groups[key]) groups[key] = { meta: [year, season, gender, type, catL, catM], order:0, in:0, soldW:0, soldC:0, stock:0, amtOrder:0, amtIn:0, amtSoldW:0, amtSoldC:0, amtStock:0 };
                    var g = groups[key];
                    g.order += safeNum(item.ë°œì£¼_ìˆ˜ëŸ‰); g.in += safeNum(item.ëˆ„ê³„ì…ê³ _ìˆ˜ëŸ‰);
                    g.soldW += safeNum(item.ê¸°ê°„íŒë§¤_ìˆ˜ëŸ‰); g.soldC += safeNum(item.ëˆ„ê³„íŒë§¤_ìˆ˜ëŸ‰);
                    g.stock += safeNum(item.ì´ì¬ê³ _ìˆ˜ëŸ‰);
                    g.amtOrder += safeNum(item.ë°œì£¼_ê¸ˆì•¡); g.amtIn += safeNum(item.ëˆ„ê³„ì…ê³ _ê¸ˆì•¡);
                    g.amtSoldW += safeNum(item.ê¸°ê°„íŒë§¤_ê¸ˆì•¡); g.amtSoldC += safeNum(item.ëˆ„ê³„íŒë§¤_ê¸ˆì•¡);
                    g.amtStock += safeNum(item.ì´ì¬ê³ _ê¸ˆì•¡);
                });

                var html = '';
                Object.values(groups).forEach(g => {
                    var m = g.meta;
                    // YoY Lookup Key: season|gender|type|catL|catM
                    var prevKey = [m[1], m[2], m[3], m[4], m[5]].join('|');
                    var ref = refMap[prevKey] || { weekQty:0, weekAmt:0, cumQty:0, cumAmt:0 };
                    
                    var inRate = g.order > 0 ? (g.in/g.order*100).toFixed(0) : 0;
                    var sellRate = g.in > 0 ? (g.soldC/g.in*100).toFixed(0) : 0;
                    
                    var weekGrowth = ref.weekAmt > 0 ? ((g.amtSoldW - ref.weekAmt)/ref.weekAmt*100).toFixed(0) : '-';
                    var cumGrowth = ref.cumAmt > 0 ? ((g.amtSoldC - ref.cumAmt)/ref.cumAmt*100).toFixed(0) : '-';
                    var growthClass = (cumGrowth !== '-' && parseInt(cumGrowth) < 0) ? 'text-danger fw-bold' : 'text-success fw-bold';

                    html += '<tr>';
                    m.forEach(t => html += '<td>'+t+'</td>');
                    html += `<td class="text-end">${formatQty(g.order)}</td><td class="text-end">${formatAmt(g.amtOrder)}</td>`;
                    html += `<td class="text-end">${formatQty(g.in)}</td><td class="text-end">${formatAmt(g.amtIn)}</td><td class="text-end">${inRate}%</td>`;
                    html += `<td class="text-end">${formatQty(g.soldW)}</td><td class="text-end">${formatAmt(g.amtSoldW)}</td>`;
                    
                    // YoY Columns
                    html += `<td class="text-end text-muted small">${ref.weekQty ? formatQty(ref.weekQty) : '-'}</td>`;
                    html += `<td class="text-end text-muted small">${ref.weekAmt ? formatAmt(ref.weekAmt) : '-'}</td>`;
                    html += `<td class="text-end ${weekGrowth.includes('-')?'':'fw-bold'}">${weekGrowth === '-' ? '-' : weekGrowth+'%'}</td>`;
                    
                    html += `<td class="text-end">${formatQty(g.soldC)}</td><td class="text-end">${formatAmt(g.amtSoldC)}</td>`;
                    
                    // YoY Columns
                    html += `<td class="text-end text-muted small">${ref.cumQty ? formatQty(ref.cumQty) : '-'}</td>`;
                    html += `<td class="text-end text-muted small">${ref.cumAmt ? formatAmt(ref.cumAmt) : '-'}</td>`;
                    html += `<td class="text-end ${growthClass}">${cumGrowth === '-' ? '-' : cumGrowth+'%'}</td>`;
                    
                    html += `<td class="text-end">${formatQty(g.stock)}</td><td class="text-end">${formatAmt(g.amtStock)}</td>`;
                    html += `<td class="text-end">${sellRate}%</td></tr>`;
                });
                $('#catBody').html(html);
                
                $('#catTable').DataTable({
                    pageLength: 20, scrollX: true,
                    fixedColumns: { leftColumns: 6 },
                    footerCallback: function(row, data, start, end, display) {
                        var api = this.api();
                        // Safe Integer Parsing
                        var intVal = function ( i ) {
                            if (typeof i === 'string') {
                                i = i.replace(/[\$,%]/g, '').replace(/,/g, '').trim();
                                return i === '' || i === '-' ? 0 : parseFloat(i);
                            }
                            return typeof i === 'number' ? i : 0;
                        };
                        
                        // Columns to Sum: Indices 6,7,8,9, 11,12,13,14, 16,17,18,19, 21,22
                        // Adjusted based on actual column count in <thead>:
                        // 0-5: Keys
                        // 6: ë°œì£¼ìˆ˜ëŸ‰, 7: ë°œì£¼ê¸ˆì•¡, 8: ì…ê³ ìˆ˜ëŸ‰, 9: ì…ê³ ê¸ˆì•¡, 10: ì…ê³ ìœ¨
                        // 11: ì£¼ê°„ìˆ˜ëŸ‰, 12: ì£¼ê°„ê¸ˆì•¡, 13: ì „ë…„ì£¼ê°„ìˆ˜ëŸ‰, 14: ì „ë…„ì£¼ê°„ê¸ˆì•¡, 15: ì£¼ê°„ì‹ ì¥
                        // 16: ì£¼ê°„ëˆ„ì ìˆ˜ëŸ‰, 17: ì£¼ê°„ëˆ„ì ê¸ˆì•¡, 18: ì „ë…„ëˆ„ì ìˆ˜ëŸ‰, 19: ì „ë…„ëˆ„ì ê¸ˆì•¡, 20: ëˆ„ì ì‹ ì¥
                        // 21: ì¬ê³ ìˆ˜ëŸ‰, 22: ì¬ê³ ê¸ˆì•¡, 23: ì†Œì§„ìœ¨
                        
                        var sumCols = [6, 7, 8, 9, 11, 12, 13, 14, 16, 17, 18, 19, 21, 22];
                        
                        sumCols.forEach(function(colIdx) {
                            var total = api.column(colIdx, { search: 'applied' }).data().reduce(function(a, b) {
                                return intVal(a) + intVal(b);
                            }, 0);
                            $(api.column(colIdx).footer()).html(total.toLocaleString());
                        });
                        
                        // Re-calculate Rates for Footer
                        var sumIn = intVal($(api.column(8).footer()).html()); // ì…ê³ 
                        var sumSold = intVal($(api.column(16).footer()).html()); // ëˆ„ì íŒë§¤
                        var rateSell = sumIn > 0 ? (sumSold / sumIn * 100).toFixed(1) + '%' : '0.0%';
                        $(api.column(23).footer()).html(rateSell);
                    }
                });
            }

            function updateItemTables(filtered) {
                var top10 = [...filtered].sort((a,b) => safeNum(b.ëˆ„ê³„íŒë§¤_ê¸ˆì•¡) - safeNum(a.ëˆ„ê³„íŒë§¤_ê¸ˆì•¡)).slice(0, 10);
                renderTable('topBody', 'topTable', top10);
                
                var risk10 = filtered.filter(x => safeNum(x.ì´ì¬ê³ _ìˆ˜ëŸ‰) > 300 && (safeNum(x.ëˆ„ê³„íŒë§¤_ìˆ˜ëŸ‰)/(safeNum(x.ëˆ„ê³„ì…ê³ _ìˆ˜ëŸ‰)||1)*100) < 15).sort((a,b) => safeNum(b.ì´ì¬ê³ _ìˆ˜ëŸ‰) - safeNum(a.ì´ì¬ê³ _ìˆ˜ëŸ‰)).slice(0, 10);
                renderTable('riskBody', 'riskTable', risk10);
                
                generateTopInsight(top10, filtered);
                generateRiskInsight(risk10, filtered);
            }
            
            function generateTopInsight(data, totalData) {
                 if(data.length===0) return $('#topInsightText').text("í•´ë‹¹ ì¡°ê±´ì˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
                 
                 var topItem = data[0];
                 var topCat = topItem.ê¸°íšì •ë³´_ë³µì¢…;
                 var topAmt = data.reduce((a,b) => a + safeNum(b.ëˆ„ê³„íŒë§¤_ê¸ˆì•¡), 0);
                 var totalAmt = totalData.reduce((a,b) => a + safeNum(b.ëˆ„ê³„íŒë§¤_ê¸ˆì•¡), 0);
                 var share = totalAmt > 0 ? (topAmt / totalAmt * 100).toFixed(1) : 0;
                 
                 var html = "<ul class='mb-0 pl-3'>";
                 html += "<li><strong>[Pareto Power]</strong> ìƒìœ„ 10ê°œ ìŠ¤íƒ€ì¼ì´ ì „ì²´ ë§¤ì¶œì˜ <span class='text-primary fw-bold'>" + share + "%</span>ë¥¼ ê²¬ì¸í•˜ê³  ìˆìŠµë‹ˆë‹¤.</li>";
                 html += "<li><strong>[Trend Leader]</strong> 1ìœ„ ì•„ì´í…œ <strong>" + topItem.ì‹œìŠ¤í…œì •ë³´_í’ˆë²ˆ + " (" + topItem.ì‹œìŠ¤í…œì •ë³´_ìƒ‰ìƒ + ")</strong>ì€ í˜„ì¬ê¹Œì§€ <strong>" + safeNum(topItem.ëˆ„ê³„íŒë§¤_ìˆ˜ëŸ‰).toLocaleString() + "ì¥</strong> íŒë§¤ë˜ì—ˆìŠµë‹ˆë‹¤.</li>";
                 html += "<li><strong>[Action]</strong> ë² ìŠ¤íŠ¸ ì•„ì´í…œì˜ ì¬ê³ ê°€ ì¶©ë¶„í•œì§€ í™•ì¸í•˜ê³ , ë¶€ì¡± ì‹œ ì¦‰ì‹œ ë¦¬ì˜¤ë”ë¥¼ ì§„í–‰í•˜ì„¸ìš”. ìœ ì‚¬ ë””ìì¸(Spot) ê¸°íšë„ ì¶”ì²œë©ë‹ˆë‹¤.</li>";
                 html += "</ul>";
                 
                 $('#topInsightText').html(html);
            }
            
            function generateRiskInsight(data, totalData) {
                if(data.length===0) return $('#riskInsightText').html("<span class='text-success'>âœ… í˜„ì¬ ì¡°ê±´ ë‚´ ì‹¬ê°í•œ ë¦¬ìŠ¤í¬ ì•„ì´í…œ(íŒë§¤ë¶€ì§„ & ê³¼ë‹¤ì¬ê³ )ì´ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ê´€ë¦¬ê°€ ì˜ ë˜ê³  ìˆìŠµë‹ˆë‹¤.</span>");
                
                var worst = data[0];
                var riskStockQty = data.reduce((a,b) => a + safeNum(b.ì´ì¬ê³ _ìˆ˜ëŸ‰), 0);
                var riskStockAmt = data.reduce((a,b) => a + safeNum(b.ì´ì¬ê³ _ê¸ˆì•¡), 0);
                
                var html = "<ul class='mb-0 pl-3'>";
                html += "<li><strong>[Risk Alert]</strong> í•˜ìœ„ 10ê°œ ì•„ì´í…œì— ë¬¶ì¸ ì¬ê³  ê¸ˆì•¡ë§Œ <strong>" + (riskStockAmt/1000000).toLocaleString(undefined, {maximumFractionDigits:0}) + "ë°±ë§Œì›</strong>ì…ë‹ˆë‹¤.</li>";
                html += "<li><strong>[Worst Inventory]</strong> <strong>" + worst.ì‹œìŠ¤í…œì •ë³´_í’ˆë²ˆ + "</strong> í’ˆë²ˆì€ ì¬ê³  <strong>" + safeNum(worst.ì´ì¬ê³ _ìˆ˜ëŸ‰).toLocaleString() + "ì¥</strong>ì„ ë³´ìœ  ì¤‘ì´ë‚˜ íŒë§¤ê°€ ë¶€ì§„í•©ë‹ˆë‹¤.</li>";
                html += "<li><strong>[Action]</strong> ë§¤ì¥ ê°„ ì´ë™(RT)ìœ¼ë¡œ íŒë§¤ ê¸°íšŒë¥¼ ëŠ˜ë¦¬ê±°ë‚˜, ê³¼ê°í•œ í• ì¸ìœ¨ì„ ì ìš©í•˜ì—¬ í˜„ê¸ˆí™”ë¥¼ ì‹œë„í•´ì•¼ í•©ë‹ˆë‹¤.</li>";
                html += "</ul>";
                
                $('#riskInsightText').html(html);
            }
            
            function renderTable(tbodyId, tableId, data) {
                var html = '';
                data.forEach(row => {
                    html += '<tr>';
                    html += `<td>${row.ì‹œìŠ¤í…œì •ë³´_í’ˆë²ˆ}</td><td>${row.ì‹œìŠ¤í…œì •ë³´_ìƒ‰ìƒ}</td><td>${row['ê¸°íšì •ë³´_ì˜ë¥˜/ìš©í’ˆ']}</td><td>${row.ê¸°íšì •ë³´_ë³µì¢…}</td>`;
                    html += `<td class="text-end">${formatQty(safeNum(row.ë°œì£¼_ìˆ˜ëŸ‰))}</td><td class="text-end">${formatAmt(safeNum(row.ë°œì£¼_ê¸ˆì•¡))}</td>`;
                    html += `<td class="text-end">${formatQty(safeNum(row.ëˆ„ê³„ì…ê³ _ìˆ˜ëŸ‰))}</td><td class="text-end">${formatAmt(safeNum(row.ëˆ„ê³„ì…ê³ _ê¸ˆì•¡))}</td>`;
                    html += `<td class="text-end">${formatPct(safeNum(row.In_Rate))}</td>`;
                    html += `<td class="text-end">${formatQty(safeNum(row.ê¸°ê°„íŒë§¤_ìˆ˜ëŸ‰))}</td><td class="text-end">${formatAmt(safeNum(row.ê¸°ê°„íŒë§¤_ê¸ˆì•¡))}</td>`;
                    html += `<td class="text-end">${formatQty(safeNum(row.ëˆ„ê³„íŒë§¤_ìˆ˜ëŸ‰))}</td><td class="text-end">${formatAmt(safeNum(row.ëˆ„ê³„íŒë§¤_ê¸ˆì•¡))}</td>`;
                    html += `<td class="text-end">${formatQty(safeNum(row.ì´ì¬ê³ _ìˆ˜ëŸ‰))}</td><td class="text-end">${formatAmt(safeNum(row.ì´ì¬ê³ _ê¸ˆì•¡))}</td>`;
                    html += `<td class="text-end">${formatPct(safeNum(row.Sell_Through))}</td>`;
                    html += '</tr>';
                });
                
                if(data.length===0) html='<tr><td colspan="16" class="text-center">No Data</td></tr>';
                $('#'+tbodyId).html(html);
                
                // Initialize/Re-initialize DataTable with Footer Callback
                if ($.fn.DataTable.isDataTable('#'+tableId)) {
                    $('#'+tableId).DataTable().destroy();
                }
                
                $('#'+tableId).DataTable({
                    scrollX: true, 
                    fixedColumns: { leftColumns: 4 },
                    paging: false, // Show all top 10/risk 10
                    searching: false,
                    info: false,
                    footerCallback: function(row, data, start, end, display) {
                        var api = this.api();
                        // Indices in Table (0-3 are text, 4 starts numbers)
                        // 4:ë°œì£¼ìˆ˜ëŸ‰, 5:ë°œì£¼ê¸ˆì•¡, 6:ì…ê³ ìˆ˜ëŸ‰, 7:ì…ê³ ê¸ˆì•¡, 8:ì…ê³ ìœ¨
                        // 9:ê¸°ê°„ìˆ˜ëŸ‰, 10:ê¸°ê°„ê¸ˆì•¡, 11:ëˆ„ì ìˆ˜ëŸ‰, 12:ëˆ„ì ê¸ˆì•¡, 13:ì¬ê³ ìˆ˜ëŸ‰, 14:ì¬ê³ ê¸ˆì•¡, 15:ì†Œì§„ìœ¨
                        
                        var safeInt = (i) => typeof i === 'string' ? parseFloat(i.replace(/,/g, '')) || 0 : typeof i === 'number' ? i : 0;
                        
                        var sumCols = [4, 5, 6, 7, 9, 10, 11, 12, 13, 14];
                        sumCols.forEach(colIdx => {
                            var total = api.column(colIdx).data().reduce((a,b) => safeInt(a) + safeInt(b), 0);
                            $(api.column(colIdx).footer()).html(total.toLocaleString());
                        });
                        
                        // Rates
                        var sumIn = safeInt($(api.column(6).footer()).html().replace(/,/g,''));
                        var sumSold = safeInt($(api.column(11).footer()).html().replace(/,/g,''));
                        var rateSell = sumIn > 0 ? (sumSold / sumIn * 100).toFixed(1) + '%' : '0.0%';
                        $(api.column(15).footer()).html(rateSell);
                    }
                });
            }
            function formatQty(val) { return val.toLocaleString(); }
            function formatAmt(val) { return Math.round(val/1000000).toLocaleString(); }
            function formatPct(val) { return val.toFixed(1) + '%'; }
    </script>
</body>
</html>
