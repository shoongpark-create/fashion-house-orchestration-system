import json
import pandas as pd
import glob
import os
import argparse
from datetime import datetime


def format_sales(amount):
    return f"{amount / 100000000:.1f}ì–µì›"


def format_price(price):
    return f"â‚©{int(price):,}"


def get_growth_icon(rate):
    if rate > 0.5:
        return "ğŸš€"
    if rate > 0:
        return "ğŸ“ˆ"
    return "ğŸ“‰"


def generate_markdown_report(data, output_dir):
    brand_name = data["brand"]
    date_str = datetime.now().strftime("%Y-%m-%d")

    # Sort products by rank
    sorted_products = sorted(data["products"], key=lambda x: x["ìˆœìœ„"])

    md_content = f"""# {brand_name} íŒë§¤ ë¶„ì„ ë¦¬í¬íŠ¸
**ë¶„ì„ì¼**: {date_str}

## 1. ë¸Œëœë“œë³„ ë§¤ì¶œ í˜„í™©
| ë¸Œëœë“œ | ë§¤ì¶œ | ì ìœ ìœ¨ | ë¹„ê³  |
| ------ | ---- | ------ | ---- |
| **{brand_name}** | **{format_sales(data["total_sales"])}** | **{data["share"]:.1f}%** | **{data["position"]}** |

## 2. {brand_name} BEST 10 ìƒí’ˆ
| ìˆœìœ„ | í’ˆëª… | TAGê°€ | íŒë§¤ìˆ˜ëŸ‰ | íŒë§¤ê¸ˆì•¡ | ì „ì£¼ëŒ€ë¹„ | í• ì¸ìœ¨ |
|------|------|-------|---------|----------|----------|--------|
"""

    for p in sorted_products:
        growth_pct = p["ì „ì£¼ëŒ€ë¹„"] * 100
        growth_str = f"{'+' if growth_pct > 0 else ''}{growth_pct:.1f}%"
        discount_pct = p["ì „ì²´í• ì¸ìœ¨"] * 100
        md_content += f"| {p['ìˆœìœ„']} | {p['í’ˆëª…']} | {format_price(p['TAGê°€'])} | {int(p['íŒë§¤ìˆ˜ëŸ‰']):,}ê°œ | {format_sales(p['íŒë§¤ê¸ˆì•¡'])} | {growth_str} | {discount_pct:.1f}% |\n"

    md_content += f"""
## 3. ì±„ë„ë³„ ë§¤ì¶œ
- **ì˜¤í”„ë¼ì¸**: {format_sales(data["channels"]["offline"]["amount"])} ({data["channels"]["offline"]["ratio"]:.1f}%)
- **ì˜¨ë¼ì¸**: {format_sales(data["channels"]["online"]["amount"])} ({data["channels"]["online"]["ratio"]:.1f}%)
- **ë©´ì„¸ì **: {format_sales(data["channels"]["dutyfree"]["amount"])} ({data["channels"]["dutyfree"]["ratio"]:.1f}%)

## 4. ì¹´í…Œê³ ë¦¬ë³„ ë¶„ì„
| ì¹´í…Œê³ ë¦¬ | ë§¤ì¶œ ë¹„ì¤‘ | íŒë§¤ìˆ˜ëŸ‰ |
|----------|----------|----------|
"""
    total_sales = data["total_sales"]
    for cat, val in data["categories"].items():
        ratio = (val["íŒë§¤ê¸ˆì•¡"] / total_sales) * 100
        md_content += f"| {cat} | {ratio:.1f}% | {int(val['íŒë§¤ìˆ˜ëŸ‰']):,}ê°œ |\n"

    md_content += "\n## 5. ì „ì£¼ ëŒ€ë¹„ ë³€í™”\n### ì„±ì¥ ìƒí’ˆ\n"
    for item in data["growth_items"][:4]:
        rate = item["ì „ì£¼ëŒ€ë¹„"] * 100
        md_content += f"- {get_growth_icon(item['ì „ì£¼ëŒ€ë¹„'])} **{item['í’ˆëª…']}**: **{'+' if rate > 0 else ''}{rate:.1f}%**\n"

    md_content += "\n### í•˜ë½ ìƒí’ˆ\n"
    for item in data["decline_items"][:4]:
        rate = item["ì „ì£¼ëŒ€ë¹„"] * 100
        md_content += f"- ğŸ“‰ {item['í’ˆëª…']}: {rate:.1f}%\n"

    # Insights placeholder - In a real scenario, this could be generated by LLM or simple rule-based logic
    md_content += """
## 6. í•µì‹¬ ì¸ì‚¬ì´íŠ¸
- **ë§¤ì¶œ ìš”ì•½**: ì‹œì¥ ì ìœ ìœ¨ ë° ì±„ë„ ë¹„ì¤‘ ê¸°ë°˜ í˜„í™© ìš”ì•½.
- **ìƒí’ˆ íŠ¸ë Œë“œ**: ê¸‰ì„±ì¥ ìƒí’ˆ ë° í•˜ë½ì„¸ ìƒí’ˆêµ° ì‹ë³„.
- **ì „ëµ ì œì–¸**: ì±„ë„ë³„/ì¹´í…Œê³ ë¦¬ë³„ ê°œì„  í¬ì¸íŠ¸ ë„ì¶œ í•„ìš”.
"""

    filename = f"sales_report_{brand_name}_{date_str.replace('-', '')}.md"
    filepath = os.path.join(output_dir, filename)

    with open(filepath, "w", encoding="utf-8") as f:
        f.write(md_content)

    return filepath


def generate_excel_dashboard(json_files, output_path):
    kpi_rows = []
    best10_rows = []
    channel_rows = []
    category_rows = []
    trends_rows = []

    brand_map = {"ì»¤ë²„ë‚«": "covernat", "ë¦¬(LEE)": "lee", "ì™€í‚¤ìœŒë¦¬": "wackywilly"}

    for json_file in json_files:
        with open(json_file, "r", encoding="utf-8") as f:
            data = json.load(f)

        brand_kr = data["brand"]
        brand_code = brand_map.get(brand_kr, brand_kr)

        # KPI
        total_qty = sum(cat["íŒë§¤ìˆ˜ëŸ‰"] for cat in data["categories"].values())
        kpi_rows.append(
            {
                "Brand": brand_code,
                "Sales": data["total_sales"],
                "Sales_Str": format_sales(data["total_sales"]),
                "Share": f"{data['share']:.1f}%",
                "Qty": f"{int(total_qty):,}",
                "Discount": f"{data['avg_discount'] * 100:.1f}%",
                "DiscountNote": "High"
                if data["avg_discount"] > 0.35
                else ("Low" if data["avg_discount"] < 0.3 else "Mid"),
            }
        )

        # Best 10
        for idx, prod in enumerate(data["products"]):
            growth = prod["ì „ì£¼ëŒ€ë¹„"] * 100
            best10_rows.append(
                [
                    brand_code,
                    idx + 1,
                    prod["í’ˆëª…"],
                    f"{int(prod['TAGê°€']):,}",
                    f"{prod['íŒë§¤ê¸ˆì•¡'] / 100000000:.2f}ì–µ",
                    f"{'+' if growth > 0 else ''}{growth:.1f}%",
                ]
            )

        # Channel
        channel_rows.append(
            {
                "Brand": brand_code,
                "Offline_Pct": round(data["channels"]["offline"]["ratio"], 1),
                "Online_Pct": round(data["channels"]["online"]["ratio"], 1),
                "DutyFree_Pct": round(data["channels"]["dutyfree"]["ratio"], 1),
            }
        )

        # Category
        cat_mapping = {
            "ì•„ìš°í„°(ë‹¤ìš´/ì í¼)": "Outer",
            "ìƒì˜(í›„ë“œ/ë§¨íˆ¬ë§¨)": "Top",
            "í‹°ì…”ì¸ ": "T-Shirts",
            "ë‹ˆíŠ¸": "Knit",
        }
        for cat, val in data["categories"].items():
            pct = (val["íŒë§¤ê¸ˆì•¡"] / data["total_sales"]) * 100
            category_rows.append([brand_code, cat_mapping.get(cat, cat), round(pct, 1)])

        # Trends
        for item in data["growth_items"][:3]:
            trends_rows.append(
                [brand_code, "Growth", item["í’ˆëª…"], f"+{item['ì „ì£¼ëŒ€ë¹„'] * 100:.1f}%"]
            )
        for item in data["decline_items"][:3]:
            trends_rows.append(
                [brand_code, "Decline", item["í’ˆëª…"], f"{item['ì „ì£¼ëŒ€ë¹„'] * 100:.1f}%"]
            )

    # Sort KPI for Rank
    kpi_rows.sort(key=lambda x: x["Sales"], reverse=True)
    for i, row in enumerate(kpi_rows):
        row["Rank"] = f"Rank #{i + 1}"

    df_kpi = pd.DataFrame(kpi_rows)[
        ["Brand", "Sales_Str", "Share", "Rank", "Qty", "Discount", "DiscountNote"]
    ]
    df_kpi.columns = [
        "Brand",
        "Sales",
        "Share",
        "Rank",
        "Qty",
        "Discount",
        "DiscountNote",
    ]

    # Insights (Template)
    insights_data = [
        [
            "market",
            "Season Transition",
            "ëª¨ë“  ë¸Œëœë“œì—ì„œ í—¤ë¹„ ì•„ìš°í„° ë§¤ì¶œ ë‘”í™”ê°€ ê´€ì¸¡ë¨. ë² ìŠ¤íŠ¸, í•˜í”„ì§‘ì—…, ê²½ëŸ‰ ì•„ìš°í„° ë“± ê°„ì ˆê¸° ì•„ì´í…œìœ¼ë¡œ ìˆ˜ìš”ê°€ ë¹ ë¥´ê²Œ ì´ë™ ì¤‘.",
        ],
        [
            "market",
            "Offline Reliance",
            "ì»¤ë²„ë‚«(75%)ê³¼ ì™€í‚¤ìœŒë¦¬(66%)ëŠ” ì—¬ì „íˆ ì˜¤í”„ë¼ì¸ ì±„ë„ ì˜ì¡´ë„ê°€ ë†’ìŒ. ë””ì§€í„¸ ì „í™˜(D2C ê°•í™”)ì´ ì‹œì¥ ì „ì²´ì˜ í•µì‹¬ ê³¼ì œë¡œ ëŒ€ë‘.",
        ],
        [
            "market",
            "Duty Free Recovery",
            "ë¦¬(Lee)ê°€ ë©´ì„¸ ì±„ë„ ì ìœ ìœ¨ 36%ë¡œ ì¸ë°”ìš´ë“œ ê´€ê´‘ íšŒë³µì„¸ë¥¼ ì„ ë„ ì¤‘. íƒ€ ë¸Œëœë“œë“¤ë„ íŠ¸ë˜ë¸” ë¦¬í…Œì¼ ì „ëµ ê°•í™”ê°€ í•„ìš”í•œ ì‹œì .",
        ],
        [
            "covernat",
            "Market Dominance",
            "45.7%ì˜ ì••ë„ì  ì ìœ ìœ¨ë¡œ 1ìœ„ ìœ ì§€. ì˜¤í”„ë¼ì¸(74.8%)ì´ ì„±ì¥ì„ ì£¼ë„.",
        ],
        [
            "lee",
            "Brand Power",
            "ê°€ì¥ ë‚®ì€ í• ì¸ìœ¨(27.2%)ë¡œ ê°•ë ¥í•œ ë¸Œëœë“œ ê°€ì¹˜ì™€ ê°€ê²© ë°©ì–´ë ¥ ì…ì¦.",
        ],
        [
            "wackywilly",
            "IP Differentiation",
            "í‚¤í‚¤ ìºë¦­í„° ì•„ì´í…œ(í›„ë“œ +21%, ìŠ¤ì›» +7%)ì´ ì„±ì¥ì„ ì£¼ë„í•˜ë©° ì°¨ë³„í™” ì„±ê³µ.",
        ],
    ]
    df_insights = pd.DataFrame(insights_data, columns=["Brand", "Title", "Description"])

    with pd.ExcelWriter(output_path, engine="openpyxl") as writer:
        df_kpi.to_excel(writer, sheet_name="KPI", index=False)
        pd.DataFrame(
            best10_rows,
            columns=[
                "Brand",
                "Rank",
                "ProductName",
                "Price",
                "SalesAmount",
                "GrowthRate",
            ],
        ).to_excel(writer, sheet_name="Best10", index=False)
        pd.DataFrame(channel_rows).to_excel(writer, sheet_name="Channel", index=False)
        pd.DataFrame(
            category_rows, columns=["Brand", "CategoryName", "Percentage"]
        ).to_excel(writer, sheet_name="Category", index=False)
        pd.DataFrame(
            trends_rows, columns=["Brand", "Type", "ProductName", "Value"]
        ).to_excel(writer, sheet_name="Trends", index=False)
        df_insights.to_excel(writer, sheet_name="Insights", index=False)

    return output_path


def main():
    parser = argparse.ArgumentParser(description="Weekly Report Generator")
    parser.add_argument(
        "--input_dir",
        required=True,
        help="Directory containing brand_analysis_*.json files",
    )
    args = parser.parse_args()

    json_files = glob.glob(os.path.join(args.input_dir, "brand_analysis_*.json"))
    if not json_files:
        print("No analysis files found.")
        return

    print(f"Found {len(json_files)} analysis files.")

    # 1. Generate Markdown Reports
    for f in json_files:
        with open(f, "r", encoding="utf-8") as json_f:
            data = json.load(json_f)
            md_path = generate_markdown_report(data, args.input_dir)
            print(f"Generated Report: {md_path}")

    # 2. Generate Excel Dashboard Data
    excel_path = os.path.join(args.input_dir, "weekly_data_template.xlsx")
    generate_excel_dashboard(json_files, excel_path)
    print(f"Generated Dashboard Data: {excel_path}")


if __name__ == "__main__":
    main()
